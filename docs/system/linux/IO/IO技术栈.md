# I/O栈

提供了软件与其它数据存储介质交换数据的能力

Linux系统I/O栈主要包括磁盘和文件系统：

1.磁盘：为系统数据提供持久化存储，在linux系统中磁盘是作为一个块设备来管理的，以块为单位读写数据，通常包括本地磁盘设备和网络存储

2.文件系统：提供管理系统文件的树状结构，在linux系统中，一切皆文件，普通的文件、目录、块设备、套接字以及管道都是通过统一的文件系统管理，文件系统为每个文件都分配一个索引节点及一个目录项数据结构，用来记录文件的元信息及目录结构：

1. 索引节点：inode用来记录文件的大小，修改日期，访问权限、数据位置等元信息，inode跟文件一一对应，inode信息也要持久化存储到磁盘
2. 目录项结构：dentry用来记录文件的名字、索引节点指针以及与其他目录项的关联关系，目录项存储在内存中

![](https://raw.githubusercontent.com/yinzhipeng123/Picture_Bed/main/202207141427692.png)

## 虚拟文件系统级缓存

虚拟文件系统：VFS给不同类型的文件系统提供了通用的接口，用户程序和内核其他子系统不需要了解各种文件系统的实现细节，通过VFS提供的接口就可以实现对文件系统的调用，VFS是处于系统调用和文件系统中间的一个抽象层，EXT3、EXT4、NFS等文件系统需要挂载到VFS目录树中的某个子目录下面才能被使用，比如LINUX系统的根目录/

缓存：为了协调快速CPU及慢速磁盘之间的性能差异，LINUX文件系统通过各种缓存实现文件的快速访问，主要包括：

1. 页缓存：缓存了虚拟内存页面，其中包括了文件系统的页面，提升了文件和目录的性能，当系统系统内存不足时，页缓存是可以回收的，可通过如下命令：grep "Cached" /proc/meminfo 查看系统页缓存大小
2. 目录项缓存：dentry记录了从目录项到VFS inode的映射关系，提高了路径名查找的性能， 可通过如下命令： grep "dentry" /proc/slabinfo 查看系统目录项缓存大小
3. 索引节点缓存： inode_cache缓存的对象是inode，包括文件访问权限、更新时间戳、文件大小等信息，可通过如下命令：grep "inode_cache" /proc/ slabinfo查看索引节点缓存大小

文件缓存是这么计算的

/proc/meminfo中

```bash
11  Active(file):     728232 kB
12  Inactive(file):   400104 kB
```

这两个值得总和

<img src="https://raw.githubusercontent.com/yinzhipeng123/Picture_Bed/main/202207141501350.png" style="zoom: 67%;" />



## 磁盘IO

在linux系统中磁盘是作为一个块设备来管理的，以块为单位读写数据，为了减少不同的块设备差异带来的影响，类似虚拟文件系统VFS，linux通过一个统一的通用块层来管理各种块设备，主要功能如下：

1. 为文件系统和应用程序，提供访问块设备的标准接口，将各种磁盘设备抽象为统一的块设备来管理
2. 对I/O请求进行调度，通过重新排序，请求合并等措施优化磁盘读写效率

I/O调度器对I/O请求进行排序，具体由采用的调度策略决定，主要策略如下

- None：不做任何调度，常用于虚拟机，磁盘I/O调度取决了宿主物理机策略
- Noop：一个先入先出的队列，只做一些基本的请求合并，适用于SSD磁盘
- Deadline：为每个I/O请求延时设定截止时间，将要达到截止时间的请求被优先处理，共使用三个队列：读FIFO、写FIFO和排序队列，通常适用于I/O求情大量的业务，比如数据库
- Cfq：完全公平队列调度把I/O时间片分配给进程，确保磁盘资源的公平使用，通常作为默认选项，可通过ionice命令对用户进程设定优先级和类别

<img src="https://raw.githubusercontent.com/yinzhipeng123/Picture_Bed/main/202207141505434.png" style="zoom:67%;" />